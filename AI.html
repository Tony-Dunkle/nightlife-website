<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nightlife Staff - AI Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #4338ca;
            }

        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
        }

        .tab-btn {
            background-color: #374151;
            color: #d1d5db;
        }

        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
            }

        .prose {
            color: #d1d5db;
        }

            .prose h1, .prose h2, .prose h3, .prose h4 {
                color: #a5b4fc;
            }

            .prose strong {
                color: #c7d2fe;
            }

            .prose ul > li::before {
                background-color: #818cf8;
            }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Main Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <nav class="w-64 bg-gray-800 p-5 flex flex-col justify-between">
            <div>
                <h1 class="text-2xl font-bold text-indigo-400 mb-10">Nightlife Staff</h1>
                <ul>
                    <li class="mb-4"><a href="dashboard.html" class="flex items-center p-2 text-base font-normal text-white rounded-lg hover:bg-gray-700"><i data-lucide="home" class="w-6 h-6"></i><span class="ml-3">Dashboard</span></a></li>
                    <li class="mb-4"><a href="admin.html" class="flex items-center p-2 text-base font-normal text-white rounded-lg hover:bg-gray-700"><i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="ml-3">Admin</span></a></li>
                    <li class="mb-4"><a href="roster.html" class="flex items-center p-2 text-base font-normal text-white rounded-lg hover:bg-gray-700"><i data-lucide="shield" class="w-6 h-6"></i><span class="ml-3">Staff Roster</span></a></li>
                    <li class="mb-4"><a href="playermanagement.html" class="flex items-center p-2 text-base font-normal text-white rounded-lg hover:bg-gray-700"><i data-lucide="notebook-pen" class="w-6 h-6"></i><span class="ml-3">Player Management</span></a></li>
                    <li class="mb-4"><a href="AI.html" class="flex items-center p-2 text-base font-normal text-white rounded-lg bg-gray-700"><i data-lucide="brain-circuit" class="w-6 h-6"></i><span class="ml-3">AI Analysis</span></a></li>
                </ul>
            </div>
            <div><button id="logout-btn" class="w-full flex items-center p-2 text-base font-normal text-white rounded-lg hover:bg-red-600 transition-colors"><i data-lucide="log-out" class="w-6 h-6"></i><span class="ml-3">Logout</span></button></div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 p-10 overflow-auto">
            <div id="loader" class="flex justify-center items-center h-full"><div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-indigo-500"></div></div>
            <div id="main-content" class="hidden">
                <h2 class="text-3xl font-bold mb-8">AI Disciplinary Assistant</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Input Section -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg">
                        <div class="mb-4">
                            <label for="player-select" class="block text-sm font-medium text-gray-300 mb-2">1. Select Player Involved</label>
                            <select id="player-select" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"><option>-- Select a Player --</option></select>
                        </div>
                        <div class="mb-4">
                            <label for="incident-description" class="block text-sm font-medium text-gray-300 mb-2">2. Describe the Incident</label>
                            <textarea id="incident-description" rows="10" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste the player report or describe the situation in detail..."></textarea>
                        </div>
                        <button id="analyze-btn" disabled class="w-full flex items-center justify-center rounded-md border border-transparent px-4 py-3 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 disabled:bg-gray-600 disabled:cursor-not-allowed">
                            <i data-lucide="sparkles" class="mr-2 h-5 w-5"></i> Analyze Incident
                        </button>
                    </div>

                    <!-- Output Section -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg">
                        <div id="ai-output-loader" class="hidden flex flex-col items-center justify-center h-full text-center"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-400 mb-4"></div><p>Analyzing incident against server rules and player history...</p></div>
                        <div id="ai-output-content" class="hidden">
                            <div class="mb-4 border-b border-gray-700"><nav class="flex space-x-2" aria-label="Tabs"><button class="tab-btn active" data-tab="violation">Violation Analysis</button><button class="tab-btn" data-tab="action">Recommended Action</button><button class="tab-btn" data-tab="response">Ticket Response</button></nav></div>
                            <div id="tab-container" class="prose max-w-none">
                                <div id="violation" class="tab-content active"></div>
                                <div id="action" class="tab-content"></div>
                                <div id="response" class="tab-content"></div>
                            </div>
                        </div>
                        <p id="ai-initial-message" class="text-center text-gray-500 pt-10">AI analysis will appear here after you describe an incident and click the analyze button.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, onSnapshot, query, orderBy, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";

        const firebaseConfig = { apiKey: "AIzaSyDC3X0D6daim4gKQhBp4S2hoBK8w4EgWRg", authDomain: "nightlife-staff.firebaseapp.com", projectId: "nightlife-staff", storageBucket: "nightlife-staff.appspot.com", messagingSenderId: "1092255472588", appId: "1:1092255472588:web:a9c2c3e3c6b2b0f2c3d4e5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('main-content');
        const logoutBtn = document.getElementById('logout-btn');
        const playerSelect = document.getElementById('player-select');
        const incidentDescription = document.getElementById('incident-description');
        const analyzeBtn = document.getElementById('analyze-btn');
        const aiOutputLoader = document.getElementById('ai-output-loader');
        const aiOutputContent = document.getElementById('ai-output-content');
        const aiInitialMessage = document.getElementById('ai-initial-message');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        let allNotes = [];
        let presenceInterval = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const currentUser = { uid: user.uid, ...userDocSnap.data() };
                    loader.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    fetchAllNotes();
                    setupPresence(currentUser);
                } else { window.location.href = 'login.html'; }
            } else { window.location.href = 'login.html'; }
        });

        function setupPresence(user) {
            const presenceDocRef = doc(db, "presence", user.uid);
            setDoc(presenceDocRef, { email: user.email, status: 'online', currentPage: document.title, lastSeen: serverTimestamp() });
            presenceInterval = setInterval(() => setDoc(presenceDocRef, { lastSeen: serverTimestamp() }, { merge: true }), 60000);
            window.addEventListener('beforeunload', () => {
                clearInterval(presenceInterval);
                setDoc(presenceDocRef, { status: 'offline', lastSeen: serverTimestamp() }, { merge: true });
            });
        }

        function fetchAllNotes() {
            const q = query(collection(db, "playerNotes"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                allNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populatePlayerSelect();
            });
        }

        function populatePlayerSelect() {
            const playerNames = [...new Set(allNotes.map(note => note.playerName))];
            playerNames.sort();
            const currentSelection = playerSelect.value;
            playerSelect.innerHTML = '<option>-- Select a Player --</option>';
            playerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                playerSelect.appendChild(option);
            });
            if (playerNames.includes(currentSelection)) playerSelect.value = currentSelection;
        }

        function checkFormValidity() {
            analyzeBtn.disabled = !(playerSelect.value !== '-- Select a Player --' && incidentDescription.value.trim().length > 10);
        }
        playerSelect.addEventListener('change', checkFormValidity);
        incidentDescription.addEventListener('input', checkFormValidity);

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });

        analyzeBtn.addEventListener('click', async () => {
            const selectedPlayer = playerSelect.value;
            const description = incidentDescription.value;
            const playerHistory = allNotes.filter(note => note.playerName === selectedPlayer);
            const formattedHistory = playerHistory.length > 0 ? playerHistory.map(n => `- ${n.noteTitle}: ${n.noteContent}`).join('\n') : "No prior offenses noted.";

            aiInitialMessage.classList.add('hidden');
            aiOutputContent.classList.add('hidden');
            aiOutputLoader.classList.remove('hidden');
            analyzeBtn.disabled = true;

            const systemPrompt = `You are an expert, impartial staff member for a FiveM roleplay server called Nightlife Roleplay. Your task is to analyze an incident report and provide a disciplinary recommendation based on the server's official rules and punishment guidelines.

                You MUST follow these steps:
                1.  **Analyze the Incident:** Read the staff member's description of the incident.
                2.  **Identify Violations:** Cross-reference the incident with the provided "Nightlife Roleplay Rules". Identify every specific rule that was broken (e.g., "RDM", "NVL", "FailRP").
                3.  **Consider Player History:** Review the player's past offenses provided. Note if they are a repeat offender for any of the identified violations.
                4.  **Consult Punishment Guidelines:** Refer to the "Disciplinary Actions Reference" to find the appropriate punishment for each violation. If the player is a repeat offender, escalate the punishment as outlined.
                5.  **Factor in Severity:** Consider the impact on the community and the quality of roleplay. A minor technical rule break during good RP should be treated less severely than a major disruption.
                6.  **Formulate Recommendation:** State the final, consolidated punishment clearly.
                7.  **Generate a Ticket Response:** Write a professional, pre-formatted response to be used in a support ticket explaining the situation to the player.

                **Output Format:** You MUST provide your response in a JSON object with three keys: "violation_analysis", "recommended_action", and "ticket_response". The content should be in Markdown.

                --- SERVER RULES DOCUMENT ---
                [PASTE THE FULL TEXT OF 'Nightlife Roleplay Rules [18+].docx' HERE]

                --- PUNISHMENT GUIDELINES DOCUMENT ---
                [PASTE THE FULL TEXT OF THE 'Disciplinary Actions Reference' TABLE HERE]`;

            const userQuery = `
                **Incident Description:**
                ${description}

                **Player Being Reported:**
                ${selectedPlayer}

                **Player's Prior Offense History:**
                ${formattedHistory}
                `;

            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const data = JSON.parse(jsonText);

                document.getElementById('violation').innerHTML = marked(data.violation_analysis || "No analysis provided.");
                document.getElementById('action').innerHTML = marked(data.recommended_action || "No action recommended.");
                document.getElementById('response').innerHTML = marked(data.ticket_response || "No response generated.");

                aiOutputContent.classList.remove('hidden');

            } catch (error) {
                console.error("AI Analysis Error:", error);
                aiInitialMessage.classList.remove('hidden');
                aiInitialMessage.textContent = "An error occurred during analysis. Please check the console and try again.";
            } finally {
                aiOutputLoader.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        lucide.createIcons();
    </script>
</body>
</html>
